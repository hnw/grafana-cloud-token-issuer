## ソフトウェア仕様書: Googleフォーム連携 Grafana Cloud トークン発行・通知システム

**1. 概要**

**1.1. 目的**
本システムは、指定されたGoogleフォームへの申請内容に基づき、Grafana Cloudのトークン発行API (Access Policy Token API) を自動的に呼び出し、発行されたトークン情報を申請者本人にメールで通知するとともに、処理結果をGoogleスプレッドシートに記録することを目的とする。これにより、トークン発行プロセスの効率化、迅速化、およびトレーサビリティの向上を図る。

**1.2. スコープ**

  * Googleフォームへの申請送信をトリガーとする。
  * Googleフォームの回答が記録されるGoogleスプレッドシートに紐付けられた Google Apps Script (GAS) を用いて実装する（コンテナバインドスクリプト）。
  * Grafana Cloud の指定されたトークン発行APIエンドポイント (`https://www.grafana.com/api/v1/tokens`) を呼び出す。
  * API呼び出しに必要な認証情報（APIキー、アクセスポリシーID、リージョン等）を安全に管理する。
  * API呼び出しの成否に基づき、処理を分岐する。
  * 成功時、申請者のメールアドレス宛にトークン情報（キー、名前、有効期限）を含む通知メールを送信する。
  * 失敗時、エラーログを記録し、指定された管理者メールアドレスにエラー通知を行う。
  * 処理の成否、日時、発行トークン名、有効期限、エラー詳細等を、回答が記録されたGoogleスプレッドシートの該当行の指定列に追記する。

**1.3. 対象読者**
本システムの開発者、運用管理者

**2. システム構成**

  * **Googleフォーム:** 申請受付インターフェース。Googleアカウントでのログインが必須であり、「メールアドレスを収集する」設定が有効であること。有効期限を選択する質問項目を含む。
  * **Googleスプレッドシート:** Googleフォームの回答記録先。GASによる処理結果（ステータス、発行トークン名、有効期限、エラー詳細等）の追記先でもある。
  * **Google Apps Script (GAS):** ビジネスロジックの実装。上記スプレッドシートのコンテナバインドスクリプトとして作成。フォーム送信トリガー (`onFormSubmit`) で起動。
      * `SpreadsheetApp`: スプレッドシートの読み取り（回答内容取得）、書き込み（結果記録）に使用。
      * `UrlFetchApp`: Grafana Cloud APIとの通信に使用。`muteHttpExceptions` オプションを利用し、エラーレスポンスもハンドリングする。
      * `MailApp`: 申請者への成功通知、管理者へのエラー通知に使用。
      * `PropertiesService`: APIキー、アクセスポリシーID、リージョン、メール設定、管理者メールアドレス等の機密情報や設定値の管理に使用。
      * `Logger`: デバッグや詳細な実行状況を把握するためのログ記録に使用。
      * `Utilities`: タイムスタンプ生成等に使用。
      * `Session`: スクリプトのタイムゾーン取得に使用。
  * **Grafana Cloud API:** Access Policy Token API (`https://www.grafana.com/api/v1/tokens`) を使用し、指定された Access Policy に紐づくトークンを発行する外部API。
  * **Google Mail:** GASからのメール送信に使用されるインフラ。

**処理フロー:**

1.  ユーザーがGoogleアカウントでログインし、Googleフォームに必要事項（有効期限の選択など）を入力して送信する。
2.  フォームの回答が、リンクされたGoogleスプレッドシートに新しい行として自動的に記録される。
3.  フォーム送信をトリガーとして、スプレッドシートに紐付けられたGASの `onFormSubmit` 関数が起動する。イベントオブジェクト `e` には回答情報やスプレッドシート上の位置情報 (`e.range`) が含まれる。
4.  GASは `PropertiesService` から必要なスクリプトプロパティ（Grafana APIキー、アクセスポリシーID、リージョン、メール設定、管理者メールアドレス）を取得し、必須項目が設定されているか検証する (NFR-01, NFR-04)。
5.  GASはイベントオブジェクト `e` (`e.response.getRespondentEmail()` 等) や、スプレッドシートの指定列 (`COLUMN_EMAIL`) から申請者のメールアドレスを取得・検証する (FR-02)。取得できない場合はエラーとする。
6.  GASはスプレッドシートの指定列 (`COLUMN_EXPIRATION`) から有効期限に関する文字列（例: "90日"）を取得し、ISO 8601形式の有効期限日時 (`expiresAtISO`) を計算する。指定形式でない場合や空の場合はデフォルト値（30日）を使用する (FR-02.1)。
7.  GASは取得したメールアドレスからトークン名を生成する（ローカルパート + タイムスタンプ）(FR-03)。
8.  GASは `UrlFetchApp` を使用して、Grafana Cloud トークン発行APIにPOSTリクエストを送信する。リクエストには、APIキーを含むAuthorizationヘッダー、アクセスポリシーID、生成したトークン名、計算した有効期限 (`expiresAtISO`) を含むペイロード、およびリージョン情報 (`region` クエリパラメータ) が含まれる (FR-03, FR-04)。
9.  GASはAPIからのレスポンス（HTTPステータスコード、レスポンスボディ）を受け取る (`muteHttpExceptions: true` によりエラーレスポンスも取得) (NFR-02)。
10. **[成功時]** (ステータスコード 2xx):
    a. レスポンスボディ (JSON) から発行されたトークンキー (`token`)、トークン名 (`name`)、有効期限 (`expiresAt`) を抽出する (FR-05-1)。
    b. 申請者のメールアドレス宛に、トークンキー、トークン名、有効期限を含む成功通知メールを `MailApp` で送信する。メール本文には、トークンを安全に取り扱い、他者に共有しないよう促す強い注意喚起を必ず記載する (FR-05-2, FR-05-3)。メール送信設定（差出人名、差出人アドレス）は `PropertiesService` から取得する。
    c. スプレッドシートの該当行の指定列 (`COLUMN_STATUS`, `COLUMN_TOKEN_NAME`, `COLUMN_EXPIRES_AT`) に、「成功」ステータス、発行されたトークン名、有効期限を `SpreadsheetApp` を用いて書き込む (FR-07)。
    d. 成功ログ（発行されたトークン名など）を `Logger.log` に記録する。
11. **[失敗時]** (ステータスコード 2xx以外、またはAPI呼び出し前後の `try-catch` で捕捉されたエラー):
    a. エラー内容（メッセージ、スタックトレース）、APIレスポンス（コード、ボディ）等を `Logger.log` に記録する (FR-06-1)。
    b. スプレッドシートの該当行の指定列 (`COLUMN_STATUS`, `COLUMN_ERROR_DETAILS`) に、「失敗」ステータスとエラー詳細メッセージを `SpreadsheetApp` を用いて書き込む (FR-07)。
    c. `PropertiesService` で管理者メールアドレス (`ADMIN_EMAIL`) が設定されていれば、そのアドレス宛にエラー通知メール（発生日時、シート/行情報、申請者メールアドレス（推定）、エラー詳細、スタックトレースを含む）を送信する (FR-06-2)。
12. `finally` ブロックで処理終了ログを記録する。

**3. 機能要件**

| ID      | 要件名                     | 詳細                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| :------ | :------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| FR-01   | フォーム送信トリガー       | Googleフォームが送信された際に、**スプレッドシートに紐づいたGAS**の `onFormSubmit` 関数が自動的に実行されること。トリガーはスクリプトエディタから手動で設定する。|
| FR-02   | 申請者メールアドレス取得   | フォーム送信イベントオブジェクト (`e.response.getRespondentEmail()`) を優先的に使用し、取得できない場合はイベントオブジェクトの `namedValues` やスプレッドシートの指定列 (`COLUMN_EMAIL`) から申請者のメールアドレスを取得すること。取得したメールアドレスが有効な形式か簡易的に検証 (`validateEmail`) し、有効なアドレスが取得できない場合はエラーとし、処理を中断・記録すること。|
| FR-02.1 | 有効期限の取得と計算     | スプレッドシートの指定列 (`COLUMN_EXPIRATION`) から有効期限を示す文字列（例: "90日"）を取得すること。`calculateExpirationDateISO` 関数により、取得した文字列を解析し、"〇〇日" 形式であればその日数を、それ以外または空の場合はデフォルト日数 (`DEFAULT_EXPIRATION_DAYS`) を使用して、現在日時から未来の日付を計算し、ISO 8601形式 (`YYYY-MM-DDTHH:mm:ssZ`) の文字列として取得すること。|
| FR-03   | トークン名の生成とAPI呼び出し準備 | `generateTokenName` 関数により、FR-02で取得した申請者のメールアドレスのローカルパート（`@`より前）を基に、使用可能な文字以外を `_` に置換し、末尾にタイムスタンプ (`yyyyMMddHHmmss`) を付加して一意なトークン名を生成すること。指定されたGrafana Cloud Access Policy Token API エンドポイント (`GRAFANA_CLOUD_API_ENDPOINT`) と `PropertiesService` から取得したリージョン (`GRAFANA_CLOUD_REGION`) を組み合わせてAPI URLを構築すること。APIリクエストのペイロードとして、生成したトークン名 (`name`)、FR-02.1で計算したISO形式の有効期限 (`expiresAt`)、`PropertiesService` から取得したアクセスポリシーID (`accessPolicyId`) を含むJSONオブジェクトを準備すること。 |
| FR-04   | Grafana API 呼び出し実行   | `createGrafanaToken` 関数内で `UrlFetchApp.fetch` を使用し、準備したAPI URL、POSTメソッド、JSONペイロード、およびFR-04で取得したAPIキーを含むAuthorizationヘッダー (`Bearer <apiKey>`) を用いてGrafana Cloud APIにリクエストを送信すること。`muteHttpExceptions: true` オプションを指定し、APIエラー時もレスポンスを取得できるようにすること。|
| FR-05   | API成功時処理            | API呼び出しが成功（HTTPステータスコード 2xx）した場合、以下の処理を行うこと。|
| FR-05-1 | トークン情報抽出         | APIレスポンスボディ（JSON形式）から、発行されたトークンキー (`token`)、トークン名 (`name`)、有効期限 (`expiresAt`) を抽出すること。|
| FR-05-2 | 成功メール送信           | `sendSuccessEmail` 関数により、FR-02で取得した申請者のメールアドレス宛に通知メールを送信すること。`PropertiesService` から取得した差出人メールアドレス (`SUCCESS_EMAIL_FROM`) と差出人名 (`SUCCESS_EMAIL_NAME`) があれば設定すること。|
| FR-05-3 | 成功メール内容           | メールの件名に「【重要】Grafana Cloud トークン発行完了のお知らせ」と記載すること。メール本文には、発行されたトークン名、トークンキー、有効期限を記載すること。本文にはトークンの機密性、他者への共有禁止、紛失時の再発行に関する強い注意喚起文言を必ず含めること。|
| FR-06   | API失敗・エラー時処理    | API呼び出しが失敗（HTTPステータスコード 2xx以外、または `try-catch` で捕捉されたスクリプト実行エラー）した場合、以下の処理を行うこと。|
| FR-06-1 | エラーログ記録           | 失敗時のHTTPステータスコード、レスポンスボディ、エラーメッセージ、スタックトレース等を `Logger.log` で記録すること。（デバッグ用）|
| FR-06-2 | 管理者へのエラー通知     | `PropertiesService` で管理者メールアドレス (`ADMIN_EMAIL`) が設定されている場合、`sendErrorEmail` 関数を呼び出し、管理者宛にエラー通知メールを送信すること。メールには、発生日時、対象シート/行、申請者メールアドレス（取得できていれば）、エラーメッセージ、スタックトレースを含めること。管理者へのメール送信が失敗しても、処理全体は続行し、エラーはログに記録するのみとする。|
| FR-07   | 処理結果のスプレッドシート記録 | `updateSpreadsheet` 関数により、`onFormSubmit` で処理した結果を、回答が記録されたスプレッドシートの該当行の指定列に追記すること。|
| FR-07-1 | 記録対象行の特定         | イベントオブジェクト `e.range.getRow()` を利用して、処理対象の回答が記録されたスプレッドシートの行番号を特定すること。|
| FR-07-2 | 記録項目                 | 以下の情報を、事前に定義された列番号 (`COLUMN_STATUS`, `COLUMN_TOKEN_NAME`, `COLUMN_EXPIRES_AT`, `COLUMN_ERROR_DETAILS`) に記録すること。\<br\>・処理ステータス（'成功'/'失敗'） (`COLUMN_STATUS`) \<br\>・発行されたトークン名 (`COLUMN_TOKEN_NAME`) (成功時のみ) \<br\>・発行されたトークンの有効期限 (`COLUMN_EXPIRES_AT`) (成功時のみ) \<br\>・エラー詳細メッセージ (`COLUMN_ERROR_DETAILS`) (失敗時のみ) \<br\>指定された列が存在しない場合はログに記録し、可能な範囲で記録を試みること。書き込み自体に失敗した場合もログに記録するのみとする。 |

**4. 非機能要件**

| ID      | 要件名         | 詳細                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| :------ | :------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| NFR-01  | セキュリティ   | Grafana Cloud APIキー (`GRAFANA_CLOUD_API_KEY`)、アクセスポリシーID (`GRAFANA_CLOUD_ACCESS_POLICY_ID`)、リージョン (`GRAFANA_CLOUD_REGION`) 等の設定値はスクリプト内にハードコードせず、`PropertiesService` のスクリプトプロパティを使用して安全に管理すること。使用するAPIキーはトークン発行に必要な最小限の権限に留めること。|
| NFR-02  | エラーハンドリング | `onFormSubmit` 全体を `try-catch-finally` で囲み、予期せぬエラー発生時もスプレッドシートへの記録や管理者通知を試みること。`UrlFetchApp.fetch` の呼び出しは `try-catch` で囲み、ネットワークエラー等に対応すること。Grafana API呼び出しでは `muteHttpExceptions: true` を使用し、レスポンスコードを確認して成功/失敗を判断すること。APIエラーレスポンスボディを解析し、可能な限り詳細なエラーメッセージを取得・記録すること。メールアドレス取得失敗、プロパティ未設定など、API呼び出し前のエラーも適切に処理・記録すること。スプレッドシート書き込み失敗、メール送信失敗が処理全体を停止させないように（ログ記録に留めるなど）配慮すること。 |
| NFR-03  | ログ記録       | 主要なステップ（処理開始、メールアドレス取得、有効期限計算、トークン名生成、API呼び出し試行、APIレスポンス、成功/失敗判定、メール送信試行、スプレッドシート書込試行、エラー発生箇所、処理終了）で `Logger.log` を使用して詳細なログを出力すること。ログには、処理対象の行番号、取得した値、APIリクエスト/レスポンス情報、エラーメッセージ等を含める。|
| NFR-04  | メンテナンス性 | コードには JSDoc 形式のコメントを付与し、変数名や関数名は分かりやすいものにすること。スプレッドシートの列番号やデフォルト有効期限、APIエンドポイント、スクリプトプロパティキーは定数として定義すること (`COLUMN_*`, `DEFAULT_EXPIRATION_DAYS`, `GRAFANA_CLOUD_API_ENDPOINT`, `PROP_KEYS`)。設定値（APIキー、アクセスポリシーID、リージョン、メール設定、管理者メールアドレス）は `PropertiesService` に集約し、`getScriptProperties` 関数で取得・検証すること。|
| NFR-05  | 実行権限       | スクリプト実行には、Googleフォーム/シートへのアクセス、スプレッドシートへの読み書き、外部サービスへの接続 (`UrlFetchApp`)、メール送信 (`MailApp`)、スクリプトプロパティへのアクセス (`PropertiesService`) の承認が必要となる。スクリプトオーナーがこれらの権限を承認する必要がある。|

**5. 前提条件・依存関係**

  * Googleアカウント（Googleフォーム、Googleスプレッドシート、Google Apps Scriptが利用可能なこと）。
  * Googleフォームが作成されており、「設定」で「メールアドレスを収集する」が有効化され、「Googleアカウントでのログインが必須」に設定されていること。
  * フォームに、トークンの有効期限を選択する質問項目（例: 選択式で "30日", "90日", "180日" 等）が定義されており、その回答がスプレッドシートの `COLUMN_EXPIRATION` で指定された列に記録されること。
  * 上記フォームの回答記録先としてGoogleスプレッドシートが設定・作成されていること。スプレッドシートには、タイムスタンプ列、フォームの回答列（メールアドレス、有効期限選択など）、およびGASが結果を書き込むための列（`COLUMN_EMAIL`, `COLUMN_EXPIRATION`, `COLUMN_STATUS`, `COLUMN_TOKEN_NAME`, `COLUMN_EXPIRES_AT`, `COLUMN_ERROR_DETAILS` で指定された列）が事前に存在すること。
  * 本システムのGASは、上記スプレッドシートのコンテナバインドスクリプトとして作成されること。
  * Grafana Cloudアカウントおよび、Access Policy Token API (`https://www.grafana.com/api/v1/tokens`) を呼び出す権限を持つ認証用APIキーが払い出されていること。
  * トークン発行に使用するアクセスポリシーがGrafana Cloud上に事前に作成されており、そのIDが判明していること。また、そのアクセスポリシーが紐づくリージョンが判明していること。
  * スクリプトプロパティに以下のキーで値が設定されていること:
      * `GRAFANA_CLOUD_API_KEY`: Grafana Cloud APIキー (必須)
      * `GRAFANA_CLOUD_ACCESS_POLICY_ID`: 使用するアクセスポリシーID (必須)
      * `GRAFANA_CLOUD_REGION`: 上記アクセスポリシーが属するリージョン (必須)
      * `ADMIN_EMAIL`: エラー通知を受け取る管理者のメールアドレス (推奨)
      * `SUCCESS_EMAIL_FROM`: 成功通知メールの差出人アドレス (任意)
      * `SUCCESS_EMAIL_NAME`: 成功通知メールの差出人名 (任意)
  * GASの `onFormSubmit` トリガーが、スクリプトエディタから「フォーム送信時」イベントに対して設定されていること。

**6. 備考・将来の考慮事項**

  * 申請内容に応じて発行するトークンの権限（アクセスポリシー）を変更する場合は、フォーム設計とGASのロジック（使用するアクセスポリシーIDの選択など）の追加が必要。
  * 大量申請が短時間で発生する場合、GASの実行時間制限（6分/実行）、API呼び出し回数制限、メール送信クォータ、スプレッドシート書き込み頻度の制限に抵触する可能性がないか検討する。
  * より堅牢なエラーハンドリング（リトライ処理など）や、Google Chatなど他の通知チャネルへの対応は将来の拡張機能とする。
  * Grafana APIキーのローテーションに関する運用手順は別途定める必要がある。
